<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>Film Negative â†’ Positive (æ—‹è½¬+å®æ—¶å‰ªè£+ç™½å¹³è¡¡+æ¸©åº¦/è‰²è°ƒ)</title>
  <style>
    /* æ•´ä½“é¡µé¢æ ·å¼ï¼šé»‘è‰²èƒŒæ™¯ä¸éœ“è™¹é£æ ¼å­—ä½“ */
    body {
      font-family: "Courier New", Courier, monospace;
      background: #000;
      color: #0ff;
      padding: 20px;
      margin: 0;
      text-align: center;
    }

    h2 {
      text-align: center;
      text-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff;
      margin: 20px auto;
    }

    /* å®¹å™¨å°ºå¯¸ä¸ canvas æ˜¾ç¤ºå°ºå¯¸åŒæ­¥ */
    #canvasContainer {
      position: relative;
      display: inline-block;
      border: 2px solid #0ff;
      box-shadow: 0 0 20px #0ff;
      margin-bottom: 20px;
    }

    canvas {
      border: 1px solid #0ff;
      background: #111;
    }

    /* å‰ªè£è¦†ç›–å±‚ï¼šéœ“è™¹ç²‰è‰²è™šçº¿è¾¹æ¡†ä¸åŠé€æ˜ç²‰è‰²èƒŒæ™¯ */
    #cropOverlay {
      border: 2px dashed #ff00ff;
      position: absolute;
      pointer-events: none;
      display: none;
      background: rgba(255, 0, 255, 0.2);
      z-index: 100;
    }

    .control {
      margin-top: 10px;
      text-align: center;
    }

    /* å›ºå®šæ»‘å—é•¿åº¦ */
    input[type="range"] {
      width: 300px;
    }

    input[type="number"] {
      width: 60px;
      margin-left: 10px;
      background: #222;
      border: 1px solid #0ff;
      color: #0ff;
    }

    /* æ–‡ä»¶ä¸Šä¼ ã€æŒ‰é’®æ ·å¼ */
    input[type="file"],
    button {
      background: #222;
      border: 1px solid #0ff;
      color: #0ff;
      padding: 5px 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    input[type="file"]:hover,
    button:hover {
      background: #0ff;
      color: #000;
    }

    /* æ»‘å—æ ·å¼å®šåˆ¶ */
    input[type="range"] {
      -webkit-appearance: none;
      background: #222;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      background: #ff00ff;
      border: 1px solid #0ff;
      cursor: pointer;
      box-shadow: 0 0 5px #ff00ff;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="module">
    import LibRaw from './index.js';
    window.LibRaw = LibRaw;
  </script>
  <!-- å¼•å…¥ UPNG.js ä»¥æ”¯æŒ PNG çš„ 16 bit è§£æ -->
  <script src="https://cdn.jsdelivr.net/npm/pako/dist/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dcraw"></script>
  <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>
  <script>
    const i18n = {
      zh: {
        title: "Film Negative â†’ Positive (æ—‹è½¬+å®æ—¶å‰ªè£+ç™½å¹³è¡¡+æ¸©åº¦/è‰²è°ƒ) æ”¯æŒ DNG",
        guideTitle: "ğŸ“˜ ä½¿ç”¨æ–¹æ³•ï¼ˆå¿«é€Ÿä¸Šæ‰‹ï¼‰",
        steps: [
          "ä¸Šä¼ åº•ç‰‡å›¾åƒï¼šç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶â€ï¼Œä¸Šä¼ æ‰«æå¥½çš„åº•ç‰‡å›¾åƒã€‚",
          "æ—‹è½¬å›¾åƒï¼šä½¿ç”¨æ»‘å—æˆ–è¾“å…¥è§’åº¦ï¼Œçº æ­£æ‰«æè§’åº¦åç‚¹å‡»â€œåº”ç”¨æ—‹è½¬â€ã€‚",
          "å‰ªè£å›¾åƒï¼šç‚¹å‡»â€œå¼€å§‹å‰ªè£â€ï¼Œç”¨é¼ æ ‡æ‹–å‡ºåŒºåŸŸåç‚¹å‡»â€œåº”ç”¨å‰ªè£â€ã€‚",
          "ç™½å¹³è¡¡è°ƒæ•´ï¼šç‚¹å‡»å›¾ä¸­åº”ä¸ºç°è‰²çš„åœ°æ–¹ï¼ˆå¦‚å¢™é¢ã€è¡£æœé˜´å½±ç­‰ï¼‰ã€‚",
          "è°ƒæ•´è‰²æ¸©/è‰²è°ƒï¼šæ‹–åŠ¨æ»‘å—æˆ–è¾“å…¥æ•°å€¼å¾®è°ƒé¢œè‰²ã€‚",
          "ä¸‹è½½ç»“æœï¼šç‚¹å‡»â€œä¸‹è½½æ ¡æ­£å›¾åƒâ€ä¿å­˜å¤„ç†åçš„å›¾ç‰‡ã€‚"
        ],
        vibranceLabel: "æ´»åŠ›",
        saturationLabel: "é¥±å’Œåº¦"
      },
      en: {
        title: "Film Negative â†’ Positive (Rotate + Crop + White Balance + Temp/Tint) support DNG",
        guideTitle: "ğŸ“˜ Quick Start Guide",
        steps: [
          "Upload a negative: Click 'Choose File' and upload your scanned film.",
          "Rotate: Use the slider or input box to correct rotation, then click 'Apply Rotation'.",
          "Crop: Click 'Start Crop', drag a region, then click 'Apply Crop'.",
          "White Balance: Click a gray area in the image (e.g., wall, clothing shadow, etc).",
          "Adjust Temp/Tint: Use sliders or input numbers to fine-tune colors.",
          "Download: Click 'Download Corrected Image' to save the result."
        ],
        vibranceLabel: "Vibrance",
        saturationLabel: "Saturation"
      },
      ja: {
        title: "ãƒ•ã‚£ãƒ«ãƒ ãƒã‚¬ â†’ ãƒã‚¸ (å›è»¢ï¼‹ãƒˆãƒªãƒŸãƒ³ã‚°ï¼‹ãƒ›ãƒ¯ã‚¤ãƒˆãƒãƒ©ãƒ³ã‚¹ï¼‹è‰²æ¸©åº¦/è‰²åˆã„) DNGå¯¾å¿œ",
        guideTitle: "ğŸ“˜ ä½¿ã„æ–¹ï¼ˆç°¡å˜ï¼‰",
        steps: [
          "ãƒã‚¬ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼šã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ã§ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿ãƒã‚¬ã‚’é¸æŠã€‚",
          "å›è»¢ï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚„æ•°å€¤å…¥åŠ›ã§å›è»¢ã‚’èª¿æ•´ã€ã€Œå›è»¢ã‚’é©ç”¨ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚",
          "ãƒˆãƒªãƒŸãƒ³ã‚°ï¼šã€ŒãƒˆãƒªãƒŸãƒ³ã‚°é–‹å§‹ã€ã§ç¯„å›²ã‚’é¸ã³ã€ã€Œé©ç”¨ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚",
          "ãƒ›ãƒ¯ã‚¤ãƒˆãƒãƒ©ãƒ³ã‚¹ï¼šç”»åƒå†…ã®ã‚°ãƒ¬ãƒ¼éƒ¨åˆ†ï¼ˆå£ãƒ»æœã®å½±ãªã©ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚",
          "è‰²æ¸©åº¦ãƒ»è‰²åˆã„èª¿æ•´ï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¾ãŸã¯æ•°å€¤å…¥åŠ›ã§å¾®èª¿æ•´ã€‚",
          "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼šã€Œè£œæ­£ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§ä¿å­˜ã€‚"
        ],
        vibranceLabel: "ãƒã‚¤ãƒ–ãƒ©ãƒ³ã‚¹",
        saturationLabel: "å½©åº¦"
      }
    };
  </script>
</head>

<body>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const lang = navigator.language.startsWith("ja") ? "ja"
        : navigator.language.startsWith("en") ? "en"
          : "zh";
      const text = i18n[lang];
      document.querySelector("#rotateControls label").childNodes[0].textContent = text.steps[1].split("ï¼š")[0] + ": ";
      document.getElementById("applyRotate").textContent = lang === "zh" ? "åº”ç”¨æ—‹è½¬" : lang === "en" ? "Apply Rotation" : "å›è»¢ã‚’é©ç”¨";

      document.getElementById("startCrop").textContent = lang === "zh" ? "å¼€å§‹å‰ªè£" : lang === "en" ? "Start Crop" : "ãƒˆãƒªãƒŸãƒ³ã‚°é–‹å§‹";
      document.getElementById("applyCrop").textContent = lang === "zh" ? "åº”ç”¨å‰ªè£" : lang === "en" ? "Apply Crop" : "é©ç”¨";
      document.getElementById("cancelCrop").textContent = lang === "zh" ? "å–æ¶ˆå‰ªè£" : lang === "en" ? "Cancel Crop" : "ãƒˆãƒªãƒŸãƒ³ã‚°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«";

      const adjustLabels = document.querySelectorAll("#adjustControls label");
      adjustLabels[0].childNodes[0].textContent = lang === "zh" ? "è‰²æ¸©: " : lang === "en" ? "Temp: " : "è‰²æ¸©: ";
      adjustLabels[1].childNodes[0].textContent = lang === "zh" ? "è‰²è°ƒ: " : lang === "en" ? "Tint: " : "è‰²åˆã„: ";
      adjustLabels[2].childNodes[0].textContent = text.vibranceLabel + ": ";
      adjustLabels[3].childNodes[0].textContent = text.saturationLabel + ": ";

      document.getElementById("download").textContent = lang === "zh" ? "ä¸‹è½½æ ¡æ­£å›¾åƒ" : lang === "en" ? "Download Corrected Image" : "è£œæ­£ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
      document.getElementById("title").textContent = text.title;
      document.getElementById("guideTitle").textContent = text.guideTitle;
      const list = document.getElementById("steps");
      list.innerHTML = "";
      text.steps.forEach(step => {
        const li = document.createElement("li");
        const parts = step.split("ï¼š");
        if (parts.length === 2) {
          li.innerHTML = `<b>${parts[0]}ï¼š</b>${parts[1]}`;
        } else {
          li.textContent = step;
        }
        list.appendChild(li);
      });
    });
  </script>
  <h2 id="title">Film Negative â†’ Positive (æ—‹è½¬+å®æ—¶å‰ªè£+ç™½å¹³è¡¡+æ¸©åº¦/è‰²è°ƒ)</h2>
  <div style="padding:16px; margin-bottom:20px;">
    <h3 id="guideTitle">ğŸ“˜ ä½¿ç”¨æ–¹æ³•ï¼ˆå¿«é€Ÿä¸Šæ‰‹ï¼‰</h3>
    <ol id="steps" style="padding-left: 20px; line-height: 1.6;">
      <li><b>ä¸Šä¼ åº•ç‰‡å›¾åƒï¼š</b>ç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶â€ï¼Œä¸Šä¼ æ‰«æå¥½çš„åº•ç‰‡å›¾åƒã€‚</li>
      <li><b>æ—‹è½¬å›¾åƒï¼š</b>ä½¿ç”¨æ»‘å—æˆ–è¾“å…¥è§’åº¦ï¼Œçº æ­£æ‰«æè§’åº¦åç‚¹å‡»â€œåº”ç”¨æ—‹è½¬â€ã€‚</li>
      <li><b>å‰ªè£å›¾åƒï¼š</b>ç‚¹å‡»â€œå¼€å§‹å‰ªè£â€ï¼Œç”¨é¼ æ ‡æ‹–å‡ºåŒºåŸŸåç‚¹å‡»â€œåº”ç”¨å‰ªè£â€ã€‚</li>
      <li><b>ç™½å¹³è¡¡è°ƒæ•´ï¼š</b>ç‚¹å‡»å›¾ä¸­åº”ä¸ºç°è‰²çš„åœ°æ–¹ï¼ˆå¦‚å¢™é¢ã€è¡£æœé˜´å½±ç­‰ï¼‰ã€‚</li>
      <li><b>è°ƒæ•´è‰²æ¸©/è‰²è°ƒï¼š</b>æ‹–åŠ¨æ»‘å—æˆ–è¾“å…¥æ•°å€¼å¾®è°ƒé¢œè‰²ã€‚</li>
      <li><b>ä¸‹è½½ç»“æœï¼š</b>ç‚¹å‡»â€œä¸‹è½½æ ¡æ­£å›¾åƒâ€ä¿å­˜å¤„ç†åçš„å›¾ç‰‡ã€‚</li>
    </ol>
  </div>
  <input type="file" id="upload" accept=".cr2,.nef,.arw,.dng,.raw,.rw2,image/*" class="control"><br>
  <!-- æ—‹è½¬æ§ä»¶ -->
  <div id="rotateControls" class="control" style="display:none;">
    <label>
      <span data-i18n="rotateLabel"></span>: <span id="rotateVal">0</span>Â°
    </label>
    <input type="range" id="rotate" min="-180" max="180" step="1" value="0">
    <input type="number" id="rotateInput" min="-180" max="180" step="1" value="0">
    <button id="applyRotate" data-i18n="applyRotate"></button>
  </div>

  <!-- å‰ªè£æ§ä»¶ -->
  <div id="cropControls" class="control" style="display:none;">
    <button id="startCrop" data-i18n="startCrop"></button>
    <button id="applyCrop" style="display:none;" data-i18n="applyCrop"></button>
    <button id="cancelCrop" style="display:none;" data-i18n="cancelCrop"></button>
  </div>

  <!-- canvas å®¹å™¨ -->
  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
    <div id="cropOverlay"></div>
  </div>

  <!-- æ¸©åº¦/è‰²è°ƒ/æ´»åŠ›/é¥±å’Œåº¦è°ƒæ•´ -->
  <div id="adjustControls" class="control" style="display:none;">
    <label>
      <span data-i18n="tempLabel"></span>: <span id="tempVal">0</span>
    </label>
    <input type="range" id="temp" min="-100" max="100" step="1" value="0">
    <input type="number" id="tempInput" min="-100" max="100" step="1" value="0">
    <br>
    <label>
      <span data-i18n="tintLabel"></span>: <span id="tintVal">0</span>
    </label>
    <input type="range" id="tint" min="-100" max="100" step="1" value="0">
    <input type="number" id="tintInput" min="-100" max="100" step="1" value="0">
    <br>
    <label>
      <span data-i18n="vibranceLabel"></span>: <span id="vibranceVal">0</span>
    </label>
    <input type="range" id="vibrance" min="-100" max="100" step="1" value="0">
    <input type="number" id="vibranceInput" min="-100" max="100" step="1" value="0">
    <br>
    <label>
      <span data-i18n="saturationLabel"></span>: <span id="saturationVal">0</span>
    </label>
    <input type="range" id="saturation" min="-100" max="100" step="1" value="0">
    <input type="number" id="saturationInput" min="-100" max="100" step="1" value="0">
    <br>
    <label>
      Cyan: <span id="cyanVal">0</span>
    </label>
    <input type="range" id="cyan" min="-100" max="100" step="1" value="0">
    <input type="number" id="cyanInput" min="-100" max="100" step="1" value="0">
    <br>
    <label>
      Magenta: <span id="magentaVal">0</span>
    </label>
    <input type="range" id="magenta" min="-100" max="100" step="1" value="0">
    <input type="number" id="magentaInput" min="-100" max="100" step="1" value="0">
    <br>
    <label>
      Yellow: <span id="yellowVal">0</span>
    </label>
    <input type="range" id="yellow" min="-100" max="100" step="1" value="0">
    <input type="number" id="yellowInput" min="-100" max="100" step="1" value="0">
    <div class="control" style="display:none;" id="downloadDiv">
      <button id="download" data-i18n="download"></button>
    </div>
  </div>
  <footer class="app-footer">
    <p>Â© 2025 Negative Converter. tokugai.com All rights reserved.</p>
  </footer>

  <script>
    $(function () {
      let canvas = $("#canvas")[0],
        ctx = canvas.getContext("2d", { willReadFrequently: true });
      // Cache common jQuery selectors
      const $canvas = $("#canvas");
      const $rotate = $("#rotate");
      const $rotateInput = $("#rotateInput");
      const $temp = $("#temp");
      const $tint = $("#tint");
      const $vibrance = $("#vibrance");
      const $saturation = $("#saturation");

      // Create a reusable offscreen canvas for rotation preview
      let offCanvas = document.createElement("canvas");

      // Throttle updateAdjust using requestAnimationFrame
      let updatePending = false;
      function scheduleUpdateAdjust() {
        if (!updatePending) {
          updatePending = true;
          requestAnimationFrame(() => {
            updateAdjust();
            updatePending = false;
          });
        }
      }
      // ç¦»å± canvas ä¿å­˜å˜æ¢åŸºåº•ï¼ˆæ—‹è½¬ã€å‰ªè£åï¼‰
      let transformCanvas = document.createElement("canvas"),
        transformCtx = transformCanvas.getContext("2d");
      let invertedImageData = null; // å½“å‰åè½¬åçš„å›¾åƒæ•°æ®ï¼ˆå†…éƒ¨åƒç´ ï¼‰
      let basePixels = null;        // ç™½å¹³è¡¡æ ¡æ­£+å½’ä¸€åŒ–åçš„æ•°æ®ï¼ˆç”¨äºæ¸©åº¦/è‰²è°ƒè°ƒæ•´ï¼‰
      let cropping = false;         // å‰ªè£æ¨¡å¼æ ‡å¿—
      let cropStart = null;         // å‰ªè£èµ·ç‚¹ï¼ˆå†…éƒ¨åæ ‡ï¼‰
      let croppingActive = false;   // æ˜¯å¦æ­£åœ¨æ‹–æ‹½é€‰æ‹©

      // æ ¹æ®å†…éƒ¨åƒç´ å°ºå¯¸è°ƒæ•´ canvas ä¸å®¹å™¨çš„ CSS æ˜¾ç¤ºå°ºå¯¸
      function adjustCanvasDisplay(w, h) {
        const maxWidth = window.innerWidth - 40,
          maxHeight = window.innerHeight - 200;
        let scale = Math.min(maxWidth / w, maxHeight / h);
        $("#canvas").css({ width: w * scale, height: h * scale });
        $("#canvasContainer").css({ width: w * scale, height: h * scale });
      }

      // å½“é€‰æ‹©æ–‡ä»¶æ—¶ï¼Œæ ¹æ®æ˜¯å¦ä¸º PNGï¼Œåˆ†æ”¯å¤„ç†
      $("#upload").on("change", function (e) {
        let file = e.target.files[0];
        if (!file) return;

        if ([".cr2", ".nef", ".arw", ".dng", ".raw", ".rw2"].some(ext => file.name.toLowerCase().endsWith(ext))) {
          let reader = new FileReader();
          reader.onload = async function (event) {
            let buffer = event.target.result;
            console.log("DEBUG: File loaded, byteLength:", buffer.byteLength);
            try {
              // åˆ›å»º LibRaw å®ä¾‹
              const raw = new LibRaw();
              console.log("DEBUG: LibRaw instance created:", raw);
              // æ‰“å¼€ RAW æ–‡ä»¶ï¼Œè®¾ç½®åŸºæœ¬é€‰é¡¹
              await raw.open(new Uint8Array(buffer), {
                noInterpolation: false,  // å¯ç”¨å†…éƒ¨å»é©¬èµ›å…‹
                useAutoWb: true,         // è‡ªåŠ¨ç™½å¹³è¡¡
                useCameraWb: true,       // ä½¿ç”¨ç›¸æœºç™½å¹³è¡¡
                useCameraMatrix: 3,      // å§‹ç»ˆä½¿ç”¨ç›¸æœºçŸ©é˜µ
                outputColor: 1,          // è¾“å‡º sRGB
                outputBps: 8             // æ¯é€šé“ 8 ä½
              });
              console.log("DEBUG: raw.open succeeded");
              // è·å–å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰
              const meta = await raw.metadata(true);
              console.log("DEBUG: Metadata:", meta);
              // è·å–è§£ç åçš„å›¾åƒæ•°æ®
              const imageDataResult = await raw.imageData();
              console.log("DEBUG: ImageData result:", imageDataResult);
              const width = imageDataResult.width;
              const height = imageDataResult.height;
              // LibRaw è¿”å›çš„æ˜¯ 3 é€šé“ RGB æ•°æ®ï¼Œè½¬æ¢ä¸º RGBAï¼ˆä¸åšè´Ÿç‰‡è½¬æ¢ï¼‰
              const rgbData = new Uint8ClampedArray(imageDataResult.data);
              const pixelCount = width * height;
              const rgbaData = new Uint8ClampedArray(pixelCount * 4);
              for (let i = 0; i < pixelCount; i++) {
                rgbaData[i * 4] = 255 - rgbData[i * 3];       // R é€šé“å–å
                rgbaData[i * 4 + 1] = 255 - rgbData[i * 3 + 1];   // G é€šé“å–å
                rgbaData[i * 4 + 2] = 255 - rgbData[i * 3 + 2];   // B é€šé“å–å
                rgbaData[i * 4 + 3] = 255;                        // A å›ºå®šä¸º 255
              }
              let imageData = new ImageData(rgbaData, width, height);
              console.log("DEBUG: ImageData created, width:", width, "height:", height);
              // æ›´æ–° canvas
              canvas.width = width;
              canvas.height = height;
              adjustCanvasDisplay(width, height);
              ctx.putImageData(imageData, 0, 0);
              console.log("DEBUG: Image displayed on canvas.");
              // åŒæ­¥æ›´æ–° transformCanvas
              transformCanvas.width = width;
              transformCanvas.height = height;
              transformCtx.putImageData(imageData, 0, 0);
              $("#rotateControls, #cropControls").show();
            } catch (err) {
              console.error("DEBUG: Error processing RAW:", err);
            }
          };
          reader.readAsArrayBuffer(file);
        } else
          // å¦‚æœæ˜¯ PNGï¼Œä½¿ç”¨ UPNG.js è§£æï¼ˆæ”¯æŒ 16 bitï¼‰
          if (file.type === "image/png") {
            let reader = new FileReader();
            reader.onload = function (event) {
              // ---------- UPNG.js è§£æéƒ¨åˆ† ----------
              const arrayBuffer = event.target.result;
              const decoded = UPNG.decode(arrayBuffer);
              const width = decoded.width;
              const height = decoded.height;
              const ctype = decoded.ctype; // é€šé“ç±»å‹ (RGB, RGBA, ç°åº¦ ç­‰)
              const depth = decoded.depth;
              const data = decoded.data;

              const channelCount = (ctype & 2 ? 3 : 1) + (ctype & 4 ? 1 : 0);
              const pixelCount = width * height;

              // ç»Ÿä¸€è½¬æ¢åˆ° 16bit (0..65535) èŒƒå›´
              let raw16 = new Uint16Array(pixelCount * channelCount);
              if (depth <= 8) {
                for (let i = 0; i < raw16.length; i++) {
                  raw16[i] = data[i] * 257; // æ‰©å±• 0..255 => 0..65535
                }
              } else {
                for (let i = 0; i < raw16.length; i++) {
                  let hi = data[2 * i],
                    lo = data[2 * i + 1];
                  raw16[i] = (hi << 8) | lo;
                }
              }

              // è´Ÿç‰‡ -> æ­£ç‰‡
              for (let i = 0; i < raw16.length; i++) {
                raw16[i] = 65535 - raw16[i];
              }

              // æœ€ç»ˆæ˜¾ç¤ºæ—¶éœ€é™åˆ° 8 bit
              let final8 = new Uint8ClampedArray(pixelCount * 4);
              for (let i = 0; i < pixelCount; i++) {
                let idx16 = i * channelCount;
                let idx8 = i * 4;
                // R
                final8[idx8] = raw16[idx16] >>> 8;
                // G / B
                if (channelCount >= 3) {
                  final8[idx8 + 1] = raw16[idx16 + 1] >>> 8;
                  final8[idx8 + 2] = raw16[idx16 + 2] >>> 8;
                } else {
                  // è‹¥ç°åº¦ï¼Œåˆ™è®© G/B ä¸ R ä¸€è‡´
                  final8[idx8 + 1] = final8[idx8];
                  final8[idx8 + 2] = final8[idx8];
                }
                // A
                if (channelCount === 4) {
                  final8[idx8 + 3] = raw16[idx16 + 3] >>> 8;
                } else {
                  final8[idx8 + 3] = 255;
                }
              }

              // å†™åˆ° canvas
              canvas.width = width;
              canvas.height = height;
              adjustCanvasDisplay(width, height);

              let imageData = ctx.createImageData(width, height);
              imageData.data.set(final8);
              ctx.putImageData(imageData, 0, 0);

              // åŒæ­¥åˆ° transformCanvas
              invertedImageData = imageData;
              transformCanvas.width = width;
              transformCanvas.height = height;
              transformCtx.putImageData(invertedImageData, 0, 0);

              // æ˜¾ç¤ºæ—‹è½¬ã€å‰ªè£æ§ä»¶
              $("#rotateControls, #cropControls").show();
            };
            reader.readAsArrayBuffer(file);

          } else {
            // è‹¥ä¸æ˜¯ PNGï¼Œåˆ™ç›´æ¥ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿæ–¹å¼ (Image å¯¹è±¡ + drawImage)
            let reader = new FileReader();
            reader.onload = function (event) {
              let img = new Image();
              img.onload = function () {
                canvas.width = img.width;
                canvas.height = img.height;
                adjustCanvasDisplay(img.width, img.height);

                // åŸç”Ÿç»˜åˆ¶
                ctx.drawImage(img, 0, 0);
                let rawData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let invertedImageData = ctx.createImageData(rawData);
                for (let i = 0; i < rawData.data.length; i += 4) {
                  invertedImageData.data[i] = 255 - rawData.data[i];
                  invertedImageData.data[i + 1] = 255 - rawData.data[i + 1];
                  invertedImageData.data[i + 2] = 255 - rawData.data[i + 2];
                  invertedImageData.data[i + 3] = 255;
                }
                ctx.putImageData(invertedImageData, 0, 0);

                // åŒæ­¥åˆ° transformCanvas
                transformCanvas.width = canvas.width;
                transformCanvas.height = canvas.height;
                transformCtx.putImageData(invertedImageData, 0, 0);

                // æ˜¾ç¤ºæ—‹è½¬ã€å‰ªè£æ§ä»¶
                $("#rotateControls, #cropControls").show();
              };
              img.src = event.target.result;
            };
            reader.readAsDataURL(file);
          }
      });

      // æ—‹è½¬é¢„è§ˆï¼ˆä¸æ›´æ–°ç¦»å±åŸºåº•ï¼‰
      function previewRotation(angleRad) {
        let w = transformCanvas.width, h = transformCanvas.height;
        let cos = Math.abs(Math.cos(angleRad)), sin = Math.abs(Math.sin(angleRad));
        let newW = Math.ceil(w * cos + h * sin),
          newH = Math.ceil(w * sin + h * cos);

        // Reuse the cached offCanvas
        offCanvas.width = newW;
        offCanvas.height = newH;
        let offCtx = offCanvas.getContext("2d");
        offCtx.clearRect(0, 0, newW, newH);
        offCtx.save();
        offCtx.translate(newW / 2, newH / 2);
        offCtx.rotate(angleRad);
        offCtx.drawImage(transformCanvas, -w / 2, -h / 2);
        offCtx.restore();

        canvas.width = newW;
        canvas.height = newH;
        adjustCanvasDisplay(newW, newH);
        ctx.clearRect(0, 0, newW, newH);
        ctx.drawImage(offCanvas, 0, 0);
        invertedImageData = ctx.getImageData(0, 0, newW, newH);
      }

      // æ—‹è½¬æ»‘å—ä¸æ•°å­—è¾“å…¥æ¡†åŒå‘ç»‘å®š
      $("#rotate").on("input", function () {
        $("#rotateVal").text($(this).val());
        $("#rotateInput").val($(this).val());
        let angle = parseFloat($(this).val()) * Math.PI / 180;
        previewRotation(angle);
      });
      $("#rotateInput").on("input", function () {
        let val = $(this).val();
        $("#rotateVal").text(val);
        $("#rotate").val(val);
        let angle = parseFloat(val) * Math.PI / 180;
        previewRotation(angle);
      });

      // åº”ç”¨æ—‹è½¬ï¼šæ›´æ–° transformCanvas
      $("#applyRotate").on("click", function () {
        let newData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        invertedImageData = newData;
        transformCanvas.width = canvas.width;
        transformCanvas.height = canvas.height;
        transformCtx.putImageData(newData, 0, 0);
        // é‡ç½®æ—‹è½¬æ§ä»¶
        $("#rotate").val(0);
        $("#rotateInput").val(0);
        $("#rotateVal").text("0");
      });

      // å‰ªè£é€»è¾‘
      $("#startCrop").on("click", function () {
        cropping = true;
        $("#cropOverlay").css({
          display: "block",
          left: 0,
          top: 0,
          width: 0,
          height: 0
        });
        $("#applyCrop, #cancelCrop").show();
        $(this).hide();
      });

      $("#canvasContainer").on("mousedown", function (e) {
        if (!cropping) return;
        croppingActive = true;
        let containerOffset = $("#canvasContainer").offset();
        let dispWidth = $("#canvas").width(),
          dispHeight = $("#canvas").height();
        let scaleX = canvas.width / dispWidth,
          scaleY = canvas.height / dispHeight;
        cropStart = {
          x: (e.pageX - containerOffset.left) * scaleX,
          y: (e.pageY - containerOffset.top) * scaleY
        };
      });

      $("#canvasContainer").on("mousemove", function (e) {
        if (!cropping || !croppingActive) return;
        let containerOffset = $("#canvasContainer").offset();
        let dispWidth = $("#canvas").width(),
          dispHeight = $("#canvas").height();
        let scaleX = canvas.width / dispWidth,
          scaleY = canvas.height / dispHeight;
        let current = {
          x: (e.pageX - containerOffset.left) * scaleX,
          y: (e.pageY - containerOffset.top) * scaleY
        };
        let leftInternal = Math.min(cropStart.x, current.x),
          topInternal = Math.min(cropStart.y, current.y),
          widthInternal = Math.abs(current.x - cropStart.x),
          heightInternal = Math.abs(current.y - cropStart.y);

        // è½¬æ¢ä¸ºæ˜¾ç¤ºåæ ‡
        let leftDisp = leftInternal / scaleX,
          topDisp = topInternal / scaleY,
          widthDisp = widthInternal / scaleX,
          heightDisp = heightInternal / scaleY;

        $("#cropOverlay").css({
          left: leftDisp,
          top: topDisp,
          width: widthDisp,
          height: heightDisp
        });
      });

      $("#canvasContainer").on("mouseup", function () {
        if (!cropping) return;
        croppingActive = false;
      });

      $("#cancelCrop").on("click", function () {
        cropping = false;
        $("#cropOverlay").hide();
        $("#applyCrop, #cancelCrop").hide();
        $("#startCrop").show();
      });

      $("#applyCrop").on("click", function () {
        let dispWidth = $("#canvas").width(),
          dispHeight = $("#canvas").height();
        let scaleX = canvas.width / dispWidth,
          scaleY = canvas.height / dispHeight;
        let overlay = $("#cropOverlay");
        let leftDisp = parseFloat(overlay.css("left")),
          topDisp = parseFloat(overlay.css("top")),
          widthDisp = parseFloat(overlay.css("width")),
          heightDisp = parseFloat(overlay.css("height"));
        let leftInternal = leftDisp * scaleX,
          topInternal = topDisp * scaleY,
          widthInternal = widthDisp * scaleX,
          heightInternal = heightDisp * scaleY;

        if (widthInternal <= 0 || heightInternal <= 0) return;

        let croppedData = transformCtx.getImageData(leftInternal, topInternal, widthInternal, heightInternal);
        canvas.width = widthInternal;
        canvas.height = heightInternal;
        adjustCanvasDisplay(widthInternal, heightInternal);
        ctx.putImageData(croppedData, 0, 0);
        invertedImageData = ctx.getImageData(0, 0, widthInternal, heightInternal);

        transformCanvas.width = widthInternal;
        transformCanvas.height = heightInternal;
        transformCtx.putImageData(invertedImageData, 0, 0);

        cropping = false;
        $("#cropOverlay").hide();
        $("#applyCrop, #cancelCrop").hide();
        $("#startCrop").show();
      });

      // ç‚¹å‡»ç”»å¸ƒï¼Œåšç™½å¹³è¡¡æ ¡æ­£ï¼ˆå‰ªè£æ¨¡å¼ä¸‹ä¸å“åº”ï¼‰
      $("#canvas").on("click", function (e) {
        if (cropping) return;
        let offset = $("#canvas").offset();
        let scaleX = canvas.width / $("#canvas").width(),
          scaleY = canvas.height / $("#canvas").height();
        let x = Math.floor((e.pageX - offset.left) * scaleX),
          y = Math.floor((e.pageY - offset.top) * scaleY);
        let idx = (y * canvas.width + x) * 4;
        let d = invertedImageData.data;
        let clickedR = d[idx], clickedG = d[idx + 1], clickedB = d[idx + 2];
        let gray = (clickedR + clickedG + clickedB) / 3;
        let sR = clickedR ? (gray / clickedR) : 1;
        let sG = clickedG ? (gray / clickedG) : 1;
        let sB = clickedB ? (gray / clickedB) : 1;
        let total = canvas.width * canvas.height;
        let corrected = new Float32Array(d.length);
        for (let i = 0; i < total; i++) {
          corrected[i * 4] = d[i * 4] * sR;
          corrected[i * 4 + 1] = d[i * 4 + 1] * sG;
          corrected[i * 4 + 2] = d[i * 4 + 2] * sB;
          corrected[i * 4 + 3] = 255;
        }
        let rMin = Infinity, rMax = -Infinity,
          gMin = Infinity, gMax = -Infinity,
          bMin = Infinity, bMax = -Infinity;
        for (let i = 0; i < total; i++) {
          let r = corrected[i * 4],
            g = corrected[i * 4 + 1],
            b = corrected[i * 4 + 2];
          rMin = Math.min(rMin, r); rMax = Math.max(rMax, r);
          gMin = Math.min(gMin, g); gMax = Math.max(gMax, g);
          bMin = Math.min(bMin, b); bMax = Math.max(bMax, b);
        }
        let finalImg = ctx.createImageData(canvas.width, canvas.height);
        for (let i = 0; i < total; i++) {
          finalImg.data[i * 4] =
            ((corrected[i * 4] - rMin) / (rMax - rMin)) * 255;
          finalImg.data[i * 4 + 1] =
            ((corrected[i * 4 + 1] - gMin) / (gMax - gMin)) * 255;
          finalImg.data[i * 4 + 2] =
            ((corrected[i * 4 + 2] - bMin) / (bMax - bMin)) * 255;
          finalImg.data[i * 4 + 3] = 255;
        }
        ctx.putImageData(finalImg, 0, 0);

        basePixels = new Float32Array(finalImg.data);
        transformCanvas.width = canvas.width;
        transformCanvas.height = canvas.height;
        transformCtx.putImageData(finalImg, 0, 0);

        $("#adjustControls, #downloadDiv").show();
      });

      // æ¸©åº¦ / è‰²è°ƒè°ƒæ•´ï¼šæ»‘å—ä¸æ•°å­—è¾“å…¥æ¡†åŒå‘ç»‘å®š
      function rgbToHsl(r, g, b) {
        r /= 255; g /= 255; b /= 255;
        let max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        if (max === min) {
          h = s = 0;
        } else {
          let d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
          }
          h /= 6;
        }
        return [h, s, l];
      }

      function hslToRgb(h, s, l) {
        let r, g, b;
        if (s === 0) {
          r = g = b = l;
        } else {
          function hue2rgb(p, q, t) {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1 / 6) return p + (q - p) * 6 * t;
            if (t < 1 / 2) return q;
            if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
            return p;
          }
          let q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          let p = 2 * l - q;
          r = hue2rgb(p, q, h + 1 / 3);
          g = hue2rgb(p, q, h);
          b = hue2rgb(p, q, h - 1 / 3);
        }
        return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
      }

      function updateAdjust() {
        let temp = parseInt($("#temp").val()),
          tint = parseInt($("#tint").val()),
          vibranceVal = parseInt($("#vibrance").val()),
          saturationVal = parseInt($("#saturation").val());
        $("#tempVal").text(temp);
        $("#tintVal").text(tint);
        $("#vibranceVal").text(vibranceVal);
        $("#saturationVal").text(saturationVal);
        $("#tempInput").val(temp);
        $("#tintInput").val(tint);
        $("#vibranceInput").val(vibranceVal);
        $("#saturationInput").val(saturationVal);

        let total = canvas.width * canvas.height;
        let adjusted = ctx.createImageData(canvas.width, canvas.height);
        let tempFactor = temp / 100,
          tintFactor = tint / 100;
        // è®¡ç®—é¥±å’Œåº¦å’Œæ´»åŠ›çš„è°ƒæ•´ç³»æ•°
        let satFactor = 1 + (saturationVal / 100);

        for (let i = 0; i < total; i++) {
          let idx = i * 4;
          let r = basePixels[idx],
            g = basePixels[idx + 1],
            b = basePixels[idx + 2];
          // å…ˆåº”ç”¨æ¸©åº¦å’Œè‰²è°ƒè°ƒæ•´
          let newR = r * (1 + tempFactor);
          let newG = g * (1 + tintFactor);
          let newB = b * (1 - tempFactor);
          newR = Math.min(255, Math.max(0, newR));
          newG = Math.min(255, Math.max(0, newG));
          newB = Math.min(255, Math.max(0, newB));

          // è½¬æ¢ä¸º HSL
          let hsl = rgbToHsl(newR, newG, newB);
          // è°ƒæ•´é¥±å’Œåº¦ï¼šå…ˆä¹˜ä¸Šç»Ÿä¸€å› å­
          hsl[1] *= satFactor;
          // å†åº”ç”¨æ´»åŠ›è°ƒæ•´ï¼šæ­£å€¼æ—¶å¢åŠ è¾ƒä½é¥±å’Œåº¦éƒ¨åˆ†ï¼Œè´Ÿå€¼æ—¶ç»Ÿä¸€ç¼©å‡
          let vibFactor = vibranceVal / 100;
          if (vibFactor >= 0) {
            hsl[1] += (1 - hsl[1]) * vibFactor;
          } else {
            hsl[1] *= (1 + vibFactor);
          }
          // é™åˆ¶é¥±å’Œåº¦åœ¨ [0,1] èŒƒå›´å†…
          hsl[1] = Math.max(0, Math.min(1, hsl[1]));

          let rgb = hslToRgb(hsl[0], hsl[1], hsl[2]);
          adjusted.data[idx] = rgb[0];
          adjusted.data[idx + 1] = rgb[1];
          adjusted.data[idx + 2] = rgb[2];
          adjusted.data[idx + 3] = 255;
        }
        // CMY è°ƒæ•´
        let cyanVal = parseInt($("#cyan").val());
        let magentaVal = parseInt($("#magenta").val());
        let yellowVal = parseInt($("#yellow").val());
        $("#cyanVal").text(cyanVal);
        $("#magentaVal").text(magentaVal);
        $("#yellowVal").text(yellowVal);
        $("#cyanInput").val(cyanVal);
        $("#magentaInput").val(magentaVal);
        $("#yellowInput").val(yellowVal);

        for (let i = 0; i < total; i++) {
          let idx = i * 4;
          let r = adjusted.data[idx],
            g = adjusted.data[idx + 1],
            b = adjusted.data[idx + 2];
          // å°† RGB è½¬æ¢åˆ° CMY
          let C = 1 - (r / 255);
          let M = 1 - (g / 255);
          let Y = 1 - (b / 255);
          // åº”ç”¨ CMY è°ƒæ•´ï¼ˆæ»‘å—å€¼ / 100ï¼‰
          let newC = Math.max(0, Math.min(1, C + cyanVal / 100));
          let newM = Math.max(0, Math.min(1, M + magentaVal / 100));
          let newY = Math.max(0, Math.min(1, Y + yellowVal / 100));
          // è½¬æ¢å› RGB
          adjusted.data[idx] = 255 * (1 - newC);
          adjusted.data[idx + 1] = 255 * (1 - newM);
          adjusted.data[idx + 2] = 255 * (1 - newY);
        }
        ctx.putImageData(adjusted, 0, 0);
      }

      $("#temp").on("input", function () {
        $("#tempVal").text($(this).val());
        $("#tempInput").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#tempInput").on("input", function () {
        $("#tempVal").text($(this).val());
        $("#temp").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#tint").on("input", function () {
        $("#tintVal").text($(this).val());
        $("#tintInput").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#tintInput").on("input", function () {
        $("#tintVal").text($(this).val());
        $("#tint").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#vibrance").on("input", function () {
        $("#vibranceVal").text($(this).val());
        $("#vibranceInput").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#vibranceInput").on("input", function () {
        $("#vibranceVal").text($(this).val());
        $("#vibrance").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#saturation").on("input", function () {
        $("#saturationVal").text($(this).val());
        $("#saturationInput").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#saturationInput").on("input", function () {
        $("#saturationVal").text($(this).val());
        $("#saturation").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#cyan").on("input", function () {
        $("#cyanVal").text($(this).val());
        $("#cyanInput").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#cyanInput").on("input", function () {
        $("#cyanVal").text($(this).val());
        $("#cyan").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#magenta").on("input", function () {
        $("#magentaVal").text($(this).val());
        $("#magentaInput").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#magentaInput").on("input", function () {
        $("#magentaVal").text($(this).val());
        $("#magenta").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#yellow").on("input", function () {
        $("#yellowVal").text($(this).val());
        $("#yellowInput").val($(this).val());
        scheduleUpdateAdjust();
      });
      $("#yellowInput").on("input", function () {
        $("#yellowVal").text($(this).val());
        $("#yellow").val($(this).val());
        scheduleUpdateAdjust();
      });

      // ä¸‹è½½
      $("#download").on("click", function () {
        let blob;
        if (window.highQualityPngData) {
          blob = new Blob([window.highQualityPngData], { type: "image/png" });
        } else {
          let dataURL = canvas.toDataURL("image/png");
          // Convert dataURL to Blob
          let arr = dataURL.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
          while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
          }
          blob = new Blob([u8arr], { type: mime });
        }
        let link = document.createElement("a");
        link.download = "corrected_film.png";
        link.href = window.URL.createObjectURL(blob);
        link.click();
      });
    });
  </script>
</body>

</html>