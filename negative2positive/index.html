<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>Film Negative â†’ Positive (æ—‹è½¬+å®æ—¶å‰ªè£+ç™½å¹³è¡¡+æ¸©åº¦/è‰²è°ƒ)</title>
  <style>
    /* æ•´ä½“é¡µé¢æ ·å¼ï¼šé»‘è‰²èƒŒæ™¯ä¸éœ“è™¹é£æ ¼å­—ä½“ */
    body {
      font-family: "Courier New", Courier, monospace;
      background: #000;
      color: #0ff;
      padding: 20px;
      margin: 0;
      text-align: center;
    }

    h2 {
      text-align: center;
      text-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff;
      margin: 20px auto;
    }

    /* å®¹å™¨å°ºå¯¸ä¸ canvas æ˜¾ç¤ºå°ºå¯¸åŒæ­¥ */
    #canvasContainer {
      position: relative;
      display: inline-block;
      border: 2px solid #0ff;
      box-shadow: 0 0 20px #0ff;
      margin-bottom: 20px;
    }

    canvas {
      border: 1px solid #0ff;
      background: #111;
    }

    /* å‰ªè£è¦†ç›–å±‚ï¼šéœ“è™¹ç²‰è‰²è™šçº¿è¾¹æ¡†ä¸åŠé€æ˜ç²‰è‰²èƒŒæ™¯ */
    #cropOverlay {
      border: 2px dashed #ff00ff;
      position: absolute;
      pointer-events: none;
      display: none;
      background: rgba(255, 0, 255, 0.2);
      z-index: 100;
    }

    .control {
      margin-top: 10px;
      text-align: center;
    }

    /* å›ºå®šæ»‘å—é•¿åº¦ */
    input[type="range"] {
      width: 300px;
    }

    input[type="number"] {
      width: 60px;
      margin-left: 10px;
      background: #222;
      border: 1px solid #0ff;
      color: #0ff;
    }

    /* æ–‡ä»¶ä¸Šä¼ ã€æŒ‰é’®æ ·å¼ */
    input[type="file"],
    button {
      background: #222;
      border: 1px solid #0ff;
      color: #0ff;
      padding: 5px 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    input[type="file"]:hover,
    button:hover {
      background: #0ff;
      color: #000;
    }

    /* æ»‘å—æ ·å¼å®šåˆ¶ */
    input[type="range"] {
      -webkit-appearance: none;
      background: #222;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 15px;
      height: 15px;
      background: #ff00ff;
      border: 1px solid #0ff;
      cursor: pointer;
      box-shadow: 0 0 5px #ff00ff;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- å¼•å…¥ UPNG.js ä»¥æ”¯æŒ PNG çš„ 16 bit è§£æ -->
  <script src="https://cdn.jsdelivr.net/npm/pako/dist/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
  <script>
    const i18n = {
      zh: {
        title: "Film Negative â†’ Positive (æ—‹è½¬+å®æ—¶å‰ªè£+ç™½å¹³è¡¡+æ¸©åº¦/è‰²è°ƒ)",
        guideTitle: "ğŸ“˜ ä½¿ç”¨æ–¹æ³•ï¼ˆå¿«é€Ÿä¸Šæ‰‹ï¼‰",
        steps: [
          "ä¸Šä¼ åº•ç‰‡å›¾åƒï¼šç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶â€ï¼Œä¸Šä¼ æ‰«æå¥½çš„åº•ç‰‡å›¾åƒã€‚",
          "æ—‹è½¬å›¾åƒï¼šä½¿ç”¨æ»‘å—æˆ–è¾“å…¥è§’åº¦ï¼Œçº æ­£æ‰«æè§’åº¦åç‚¹å‡»â€œåº”ç”¨æ—‹è½¬â€ã€‚",
          "å‰ªè£å›¾åƒï¼šç‚¹å‡»â€œå¼€å§‹å‰ªè£â€ï¼Œç”¨é¼ æ ‡æ‹–å‡ºåŒºåŸŸåç‚¹å‡»â€œåº”ç”¨å‰ªè£â€ã€‚",
          "ç™½å¹³è¡¡è°ƒæ•´ï¼šç‚¹å‡»å›¾ä¸­åº”ä¸ºç°è‰²çš„åœ°æ–¹ï¼ˆå¦‚å¢™é¢ã€è¡£æœé˜´å½±ç­‰ï¼‰ã€‚",
          "è°ƒæ•´è‰²æ¸©/è‰²è°ƒï¼šæ‹–åŠ¨æ»‘å—æˆ–è¾“å…¥æ•°å€¼å¾®è°ƒé¢œè‰²ã€‚",
          "ä¸‹è½½ç»“æœï¼šç‚¹å‡»â€œä¸‹è½½æ ¡æ­£å›¾åƒâ€ä¿å­˜å¤„ç†åçš„å›¾ç‰‡ã€‚"
        ]
      },
      en: {
        title: "Film Negative â†’ Positive (Rotate + Crop + White Balance + Temp/Tint)",
        guideTitle: "ğŸ“˜ Quick Start Guide",
        steps: [
          "Upload a negative: Click 'Choose File' and upload your scanned film.",
          "Rotate: Use the slider or input box to correct rotation, then click 'Apply Rotation'.",
          "Crop: Click 'Start Crop', drag a region, then click 'Apply Crop'.",
          "White Balance: Click a gray area in the image (e.g., wall, clothing shadow, etc).",
          "Adjust Temp/Tint: Use sliders or input numbers to fine-tune colors.",
          "Download: Click 'Download Corrected Image' to save the result."
        ]
      },
      ja: {
        title: "ãƒ•ã‚£ãƒ«ãƒ ãƒã‚¬ â†’ ãƒã‚¸ (å›è»¢ï¼‹ãƒˆãƒªãƒŸãƒ³ã‚°ï¼‹ãƒ›ãƒ¯ã‚¤ãƒˆãƒãƒ©ãƒ³ã‚¹ï¼‹è‰²æ¸©åº¦/è‰²åˆã„)",
        guideTitle: "ğŸ“˜ ä½¿ã„æ–¹ï¼ˆç°¡å˜ï¼‰",
        steps: [
          "ãƒã‚¬ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼šã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ã§ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿ãƒã‚¬ã‚’é¸æŠã€‚",
          "å›è»¢ï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚„æ•°å€¤å…¥åŠ›ã§å›è»¢ã‚’èª¿æ•´ã€ã€Œå›è»¢ã‚’é©ç”¨ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚",
          "ãƒˆãƒªãƒŸãƒ³ã‚°ï¼šã€ŒãƒˆãƒªãƒŸãƒ³ã‚°é–‹å§‹ã€ã§ç¯„å›²ã‚’é¸ã³ã€ã€Œé©ç”¨ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚",
          "ãƒ›ãƒ¯ã‚¤ãƒˆãƒãƒ©ãƒ³ã‚¹ï¼šç”»åƒå†…ã®ã‚°ãƒ¬ãƒ¼éƒ¨åˆ†ï¼ˆå£ãƒ»æœã®å½±ãªã©ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚",
          "è‰²æ¸©åº¦ãƒ»è‰²åˆã„èª¿æ•´ï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¾ãŸã¯æ•°å€¤å…¥åŠ›ã§å¾®èª¿æ•´ã€‚",
          "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼šã€Œè£œæ­£ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§ä¿å­˜ã€‚"
        ]
      }
    };
  </script>
</head>

<body>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const lang = navigator.language.startsWith("ja") ? "ja"
        : navigator.language.startsWith("en") ? "en"
          : "zh";
      const text = i18n[lang];
      document.getElementById("title").textContent = text.title;
      document.getElementById("guideTitle").textContent = text.guideTitle;
      const list = document.getElementById("steps");
      list.innerHTML = "";
      text.steps.forEach(step => {
        const li = document.createElement("li");
        const parts = step.split("ï¼š");
        if (parts.length === 2) {
          li.innerHTML = `<b>${parts[0]}ï¼š</b>${parts[1]}`;
        } else {
          li.textContent = step;
        }
        list.appendChild(li);
      });
    });
  </script>
  <h2 id="title">Film Negative â†’ Positive (æ—‹è½¬+å®æ—¶å‰ªè£+ç™½å¹³è¡¡+æ¸©åº¦/è‰²è°ƒ)</h2>
  <div style="padding:16px; margin-bottom:20px;">
    <h3 id="guideTitle">ğŸ“˜ ä½¿ç”¨æ–¹æ³•ï¼ˆå¿«é€Ÿä¸Šæ‰‹ï¼‰</h3>
    <ol id="steps" style="padding-left: 20px; line-height: 1.6;">
      <li><b>ä¸Šä¼ åº•ç‰‡å›¾åƒï¼š</b>ç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶â€ï¼Œä¸Šä¼ æ‰«æå¥½çš„åº•ç‰‡å›¾åƒã€‚</li>
      <li><b>æ—‹è½¬å›¾åƒï¼š</b>ä½¿ç”¨æ»‘å—æˆ–è¾“å…¥è§’åº¦ï¼Œçº æ­£æ‰«æè§’åº¦åç‚¹å‡»â€œåº”ç”¨æ—‹è½¬â€ã€‚</li>
      <li><b>å‰ªè£å›¾åƒï¼š</b>ç‚¹å‡»â€œå¼€å§‹å‰ªè£â€ï¼Œç”¨é¼ æ ‡æ‹–å‡ºåŒºåŸŸåç‚¹å‡»â€œåº”ç”¨å‰ªè£â€ã€‚</li>
      <li><b>ç™½å¹³è¡¡è°ƒæ•´ï¼š</b>ç‚¹å‡»å›¾ä¸­åº”ä¸ºç°è‰²çš„åœ°æ–¹ï¼ˆå¦‚å¢™é¢ã€è¡£æœé˜´å½±ç­‰ï¼‰ã€‚</li>
      <li><b>è°ƒæ•´è‰²æ¸©/è‰²è°ƒï¼š</b>æ‹–åŠ¨æ»‘å—æˆ–è¾“å…¥æ•°å€¼å¾®è°ƒé¢œè‰²ã€‚</li>
      <li><b>ä¸‹è½½ç»“æœï¼š</b>ç‚¹å‡»â€œä¸‹è½½æ ¡æ­£å›¾åƒâ€ä¿å­˜å¤„ç†åçš„å›¾ç‰‡ã€‚</li>
    </ol>
  </div>
  <input type="file" id="upload" accept="image/*" class="control"><br>
  <!-- æ—‹è½¬æ§ä»¶ -->
  <div id="rotateControls" class="control" style="display:none;">
    <label>æ—‹è½¬: <span id="rotateVal">0</span>Â°</label>
    <input type="range" id="rotate" min="-180" max="180" step="1" value="0">
    <input type="number" id="rotateInput" min="-180" max="180" step="1" value="0">
    <button id="applyRotate">åº”ç”¨æ—‹è½¬</button>
  </div>
  <!-- å‰ªè£æ§ä»¶ -->
  <div id="cropControls" class="control" style="display:none;">
    <button id="startCrop">å¼€å§‹å‰ªè£</button>
    <button id="applyCrop" style="display:none;">åº”ç”¨å‰ªè£</button>
    <button id="cancelCrop" style="display:none;">å–æ¶ˆå‰ªè£</button>
  </div>
  <!-- canvas å®¹å™¨ -->
  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
    <div id="cropOverlay"></div>
  </div>
  <!-- æ¸©åº¦/è‰²è°ƒè°ƒæ•´ -->
  <div id="adjustControls" class="control" style="display:none;">
    <label>æ¸©åº¦: <span id="tempVal">0</span></label>
    <input type="range" id="temp" min="-100" max="100" step="1" value="0">
    <input type="number" id="tempInput" min="-100" max="100" step="1" value="0">
    <br>
    <label>è‰²è°ƒ: <span id="tintVal">0</span></label>
    <input type="range" id="tint" min="-100" max="100" step="1" value="0">
    <input type="number" id="tintInput" min="-100" max="100" step="1" value="0">
  </div>
  <div class="control" style="display:none;" id="downloadDiv">
    <button id="download">ä¸‹è½½æ ¡æ­£å›¾åƒ</button>
  </div>

  <script>
    $(function () {
      let canvas = $("#canvas")[0],
          ctx = canvas.getContext("2d");
      // ç¦»å± canvas ä¿å­˜å˜æ¢åŸºåº•ï¼ˆæ—‹è½¬ã€å‰ªè£åï¼‰
      let transformCanvas = document.createElement("canvas"),
          transformCtx = transformCanvas.getContext("2d");
      let invertedImageData = null; // å½“å‰åè½¬åçš„å›¾åƒæ•°æ®ï¼ˆå†…éƒ¨åƒç´ ï¼‰
      let basePixels = null;        // ç™½å¹³è¡¡æ ¡æ­£+å½’ä¸€åŒ–åçš„æ•°æ®ï¼ˆç”¨äºæ¸©åº¦/è‰²è°ƒè°ƒæ•´ï¼‰
      let cropping = false;         // å‰ªè£æ¨¡å¼æ ‡å¿—
      let cropStart = null;         // å‰ªè£èµ·ç‚¹ï¼ˆå†…éƒ¨åæ ‡ï¼‰
      let croppingActive = false;   // æ˜¯å¦æ­£åœ¨æ‹–æ‹½é€‰æ‹©

      // æ ¹æ®å†…éƒ¨åƒç´ å°ºå¯¸è°ƒæ•´ canvas ä¸å®¹å™¨çš„ CSS æ˜¾ç¤ºå°ºå¯¸
      function adjustCanvasDisplay(w, h) {
        const maxWidth = window.innerWidth - 40,
              maxHeight = window.innerHeight - 200;
        let scale = Math.min(maxWidth / w, maxHeight / h, 1);
        $("#canvas").css({ width: w * scale, height: h * scale });
        $("#canvasContainer").css({ width: w * scale, height: h * scale });
      }

      // å½“é€‰æ‹©æ–‡ä»¶æ—¶ï¼Œæ ¹æ®æ˜¯å¦ä¸º PNGï¼Œåˆ†æ”¯å¤„ç†
      $("#upload").on("change", function (e) {
        let file = e.target.files[0];
        if (!file) return;

        // å¦‚æœæ˜¯ PNGï¼Œä½¿ç”¨ UPNG.js è§£æï¼ˆæ”¯æŒ 16 bitï¼‰
        if (file.type === "image/png") {
          let reader = new FileReader();
          reader.onload = function (event) {
            // ---------- UPNG.js è§£æéƒ¨åˆ† ----------
            const arrayBuffer = event.target.result;
            const decoded = UPNG.decode(arrayBuffer);
            const width = decoded.width;
            const height = decoded.height;
            const ctype = decoded.ctype; // é€šé“ç±»å‹ (RGB, RGBA, ç°åº¦ ç­‰)
            const depth = decoded.depth;
            const data = decoded.data;

            const channelCount = (ctype & 2 ? 3 : 1) + (ctype & 4 ? 1 : 0);
            const pixelCount = width * height;

            // ç»Ÿä¸€è½¬æ¢åˆ° 16bit (0..65535) èŒƒå›´
            let raw16 = new Uint16Array(pixelCount * channelCount);
            if (depth <= 8) {
              for (let i = 0; i < raw16.length; i++) {
                raw16[i] = data[i] * 257; // æ‰©å±• 0..255 => 0..65535
              }
            } else {
              for (let i = 0; i < raw16.length; i++) {
                let hi = data[2 * i],
                    lo = data[2 * i + 1];
                raw16[i] = (hi << 8) | lo;
              }
            }

            // è´Ÿç‰‡ -> æ­£ç‰‡
            for (let i = 0; i < raw16.length; i++) {
              raw16[i] = 65535 - raw16[i];
            }

            // æœ€ç»ˆæ˜¾ç¤ºæ—¶éœ€é™åˆ° 8 bit
            let final8 = new Uint8ClampedArray(pixelCount * 4);
            for (let i = 0; i < pixelCount; i++) {
              let idx16 = i * channelCount;
              let idx8 = i * 4;
              // R
              final8[idx8] = raw16[idx16] >>> 8;
              // G / B
              if (channelCount >= 3) {
                final8[idx8 + 1] = raw16[idx16 + 1] >>> 8;
                final8[idx8 + 2] = raw16[idx16 + 2] >>> 8;
              } else {
                // è‹¥ç°åº¦ï¼Œåˆ™è®© G/B ä¸ R ä¸€è‡´
                final8[idx8 + 1] = final8[idx8];
                final8[idx8 + 2] = final8[idx8];
              }
              // A
              if (channelCount === 4) {
                final8[idx8 + 3] = raw16[idx16 + 3] >>> 8;
              } else {
                final8[idx8 + 3] = 255;
              }
            }

            // å†™åˆ° canvas
            canvas.width = width;
            canvas.height = height;
            adjustCanvasDisplay(width, height);

            let imageData = ctx.createImageData(width, height);
            imageData.data.set(final8);
            ctx.putImageData(imageData, 0, 0);

            // åŒæ­¥åˆ° transformCanvas
            invertedImageData = imageData;
            transformCanvas.width = width;
            transformCanvas.height = height;
            transformCtx.putImageData(invertedImageData, 0, 0);

            // æ˜¾ç¤ºæ—‹è½¬ã€å‰ªè£æ§ä»¶
            $("#rotateControls, #cropControls").show();
          };
          reader.readAsArrayBuffer(file);

        } else {
          // è‹¥ä¸æ˜¯ PNGï¼Œåˆ™ç›´æ¥ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿæ–¹å¼ (Image å¯¹è±¡ + drawImage)
          let reader = new FileReader();
          reader.onload = function (event) {
            let img = new Image();
            img.onload = function () {
              canvas.width = img.width;
              canvas.height = img.height;
              adjustCanvasDisplay(img.width, img.height);

              // åŸç”Ÿç»˜åˆ¶
              ctx.drawImage(img, 0, 0);
              let rawData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              let invertedImageData = ctx.createImageData(rawData);
              for (let i = 0; i < rawData.data.length; i += 4) {
                invertedImageData.data[i]     = 255 - rawData.data[i];
                invertedImageData.data[i + 1] = 255 - rawData.data[i + 1];
                invertedImageData.data[i + 2] = 255 - rawData.data[i + 2];
                invertedImageData.data[i + 3] = 255;
              }
              ctx.putImageData(invertedImageData, 0, 0);

              // åŒæ­¥åˆ° transformCanvas
              transformCanvas.width = canvas.width;
              transformCanvas.height = canvas.height;
              transformCtx.putImageData(invertedImageData, 0, 0);

              // æ˜¾ç¤ºæ—‹è½¬ã€å‰ªè£æ§ä»¶
              $("#rotateControls, #cropControls").show();
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // æ—‹è½¬é¢„è§ˆï¼ˆä¸æ›´æ–°ç¦»å±åŸºåº•ï¼‰
      function previewRotation(angleRad) {
        let w = transformCanvas.width, h = transformCanvas.height;
        let cos = Math.abs(Math.cos(angleRad)), sin = Math.abs(Math.sin(angleRad));
        let newW = Math.ceil(w * cos + h * sin),
            newH = Math.ceil(w * sin + h * cos);
        let offCanvas = document.createElement("canvas");
        offCanvas.width = newW;
        offCanvas.height = newH;
        let offCtx = offCanvas.getContext("2d");
        offCtx.translate(newW / 2, newH / 2);
        offCtx.rotate(angleRad);
        offCtx.drawImage(transformCanvas, -w / 2, -h / 2);

        canvas.width = newW;
        canvas.height = newH;
        adjustCanvasDisplay(newW, newH);
        ctx.clearRect(0, 0, newW, newH);
        ctx.drawImage(offCanvas, 0, 0);
        invertedImageData = ctx.getImageData(0, 0, newW, newH);
      }

      // æ—‹è½¬æ»‘å—ä¸æ•°å­—è¾“å…¥æ¡†åŒå‘ç»‘å®š
      $("#rotate").on("input", function () {
        $("#rotateVal").text($(this).val());
        $("#rotateInput").val($(this).val());
        let angle = parseFloat($(this).val()) * Math.PI / 180;
        previewRotation(angle);
      });
      $("#rotateInput").on("input", function () {
        let val = $(this).val();
        $("#rotateVal").text(val);
        $("#rotate").val(val);
        let angle = parseFloat(val) * Math.PI / 180;
        previewRotation(angle);
      });

      // åº”ç”¨æ—‹è½¬ï¼šæ›´æ–° transformCanvas
      $("#applyRotate").on("click", function () {
        let newData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        invertedImageData = newData;
        transformCanvas.width = canvas.width;
        transformCanvas.height = canvas.height;
        transformCtx.putImageData(newData, 0, 0);
        // é‡ç½®æ—‹è½¬æ§ä»¶
        $("#rotate").val(0);
        $("#rotateInput").val(0);
        $("#rotateVal").text("0");
      });

      // å‰ªè£é€»è¾‘
      $("#startCrop").on("click", function () {
        cropping = true;
        $("#cropOverlay").css({
          display: "block",
          left: 0,
          top: 0,
          width: 0,
          height: 0
        });
        $("#applyCrop, #cancelCrop").show();
        $(this).hide();
      });

      $("#canvasContainer").on("mousedown", function (e) {
        if (!cropping) return;
        croppingActive = true;
        let containerOffset = $("#canvasContainer").offset();
        let dispWidth = $("#canvas").width(),
            dispHeight = $("#canvas").height();
        let scaleX = canvas.width / dispWidth,
            scaleY = canvas.height / dispHeight;
        cropStart = {
          x: (e.pageX - containerOffset.left) * scaleX,
          y: (e.pageY - containerOffset.top) * scaleY
        };
      });

      $("#canvasContainer").on("mousemove", function (e) {
        if (!cropping || !croppingActive) return;
        let containerOffset = $("#canvasContainer").offset();
        let dispWidth = $("#canvas").width(),
            dispHeight = $("#canvas").height();
        let scaleX = canvas.width / dispWidth,
            scaleY = canvas.height / dispHeight;
        let current = {
          x: (e.pageX - containerOffset.left) * scaleX,
          y: (e.pageY - containerOffset.top) * scaleY
        };
        let leftInternal = Math.min(cropStart.x, current.x),
            topInternal = Math.min(cropStart.y, current.y),
            widthInternal = Math.abs(current.x - cropStart.x),
            heightInternal = Math.abs(current.y - cropStart.y);

        // è½¬æ¢ä¸ºæ˜¾ç¤ºåæ ‡
        let leftDisp = leftInternal / scaleX,
            topDisp = topInternal / scaleY,
            widthDisp = widthInternal / scaleX,
            heightDisp = heightInternal / scaleY;

        $("#cropOverlay").css({
          left: leftDisp,
          top: topDisp,
          width: widthDisp,
          height: heightDisp
        });
      });

      $("#canvasContainer").on("mouseup", function () {
        if (!cropping) return;
        croppingActive = false;
      });

      $("#cancelCrop").on("click", function () {
        cropping = false;
        $("#cropOverlay").hide();
        $("#applyCrop, #cancelCrop").hide();
        $("#startCrop").show();
      });

      $("#applyCrop").on("click", function () {
        let dispWidth = $("#canvas").width(),
            dispHeight = $("#canvas").height();
        let scaleX = canvas.width / dispWidth,
            scaleY = canvas.height / dispHeight;
        let overlay = $("#cropOverlay");
        let leftDisp = parseFloat(overlay.css("left")),
            topDisp = parseFloat(overlay.css("top")),
            widthDisp = parseFloat(overlay.css("width")),
            heightDisp = parseFloat(overlay.css("height"));
        let leftInternal = leftDisp * scaleX,
            topInternal = topDisp * scaleY,
            widthInternal = widthDisp * scaleX,
            heightInternal = heightDisp * scaleY;

        if (widthInternal <= 0 || heightInternal <= 0) return;

        let croppedData = transformCtx.getImageData(leftInternal, topInternal, widthInternal, heightInternal);
        canvas.width = widthInternal;
        canvas.height = heightInternal;
        adjustCanvasDisplay(widthInternal, heightInternal);
        ctx.putImageData(croppedData, 0, 0);
        invertedImageData = ctx.getImageData(0, 0, widthInternal, heightInternal);

        transformCanvas.width = widthInternal;
        transformCanvas.height = heightInternal;
        transformCtx.putImageData(invertedImageData, 0, 0);

        cropping = false;
        $("#cropOverlay").hide();
        $("#applyCrop, #cancelCrop").hide();
        $("#startCrop").show();
      });

      // ç‚¹å‡»ç”»å¸ƒï¼Œåšç™½å¹³è¡¡æ ¡æ­£ï¼ˆå‰ªè£æ¨¡å¼ä¸‹ä¸å“åº”ï¼‰
      $("#canvas").on("click", function (e) {
        if (cropping) return;
        let offset = $("#canvas").offset();
        let scaleX = canvas.width / $("#canvas").width(),
            scaleY = canvas.height / $("#canvas").height();
        let x = Math.floor((e.pageX - offset.left) * scaleX),
            y = Math.floor((e.pageY - offset.top) * scaleY);
        let idx = (y * canvas.width + x) * 4;
        let d = invertedImageData.data;
        let clickedR = d[idx], clickedG = d[idx + 1], clickedB = d[idx + 2];
        let gray = (clickedR + clickedG + clickedB) / 3;
        let sR = clickedR ? (gray / clickedR) : 1;
        let sG = clickedG ? (gray / clickedG) : 1;
        let sB = clickedB ? (gray / clickedB) : 1;
        let total = canvas.width * canvas.height;
        let corrected = new Float32Array(d.length);
        for (let i = 0; i < total; i++) {
          corrected[i * 4] = d[i * 4] * sR;
          corrected[i * 4 + 1] = d[i * 4 + 1] * sG;
          corrected[i * 4 + 2] = d[i * 4 + 2] * sB;
          corrected[i * 4 + 3] = 255;
        }
        let rMin = Infinity, rMax = -Infinity,
            gMin = Infinity, gMax = -Infinity,
            bMin = Infinity, bMax = -Infinity;
        for (let i = 0; i < total; i++) {
          let r = corrected[i * 4],
              g = corrected[i * 4 + 1],
              b = corrected[i * 4 + 2];
          rMin = Math.min(rMin, r); rMax = Math.max(rMax, r);
          gMin = Math.min(gMin, g); gMax = Math.max(gMax, g);
          bMin = Math.min(bMin, b); bMax = Math.max(bMax, b);
        }
        let finalImg = ctx.createImageData(canvas.width, canvas.height);
        for (let i = 0; i < total; i++) {
          finalImg.data[i * 4] =
            ((corrected[i * 4] - rMin) / (rMax - rMin)) * 255;
          finalImg.data[i * 4 + 1] =
            ((corrected[i * 4 + 1] - gMin) / (gMax - gMin)) * 255;
          finalImg.data[i * 4 + 2] =
            ((corrected[i * 4 + 2] - bMin) / (bMax - bMin)) * 255;
          finalImg.data[i * 4 + 3] = 255;
        }
        ctx.putImageData(finalImg, 0, 0);

        basePixels = new Float32Array(finalImg.data);
        transformCanvas.width = canvas.width;
        transformCanvas.height = canvas.height;
        transformCtx.putImageData(finalImg, 0, 0);

        $("#adjustControls, #downloadDiv").show();
      });

      // æ¸©åº¦ / è‰²è°ƒè°ƒæ•´ï¼šæ»‘å—ä¸æ•°å­—è¾“å…¥æ¡†åŒå‘ç»‘å®š
      function updateAdjust() {
        let temp = parseInt($("#temp").val()),
            tint = parseInt($("#tint").val());
        $("#tempVal").text(temp);
        $("#tintVal").text(tint);
        $("#tempInput").val(temp);
        $("#tintInput").val(tint);

        let total = canvas.width * canvas.height;
        let adjusted = ctx.createImageData(canvas.width, canvas.height);
        let tempFactor = temp / 100,
            tintFactor = tint / 100;
        for (let i = 0; i < total; i++) {
          let idx = i * 4;
          let r = basePixels[idx],
              g = basePixels[idx + 1],
              b = basePixels[idx + 2];
          let newR = r * (1 + tempFactor);
          let newG = g * (1 + tintFactor);
          let newB = b * (1 - tempFactor);
          adjusted.data[idx]     = Math.min(255, Math.max(0, newR));
          adjusted.data[idx + 1] = Math.min(255, Math.max(0, newG));
          adjusted.data[idx + 2] = Math.min(255, Math.max(0, newB));
          adjusted.data[idx + 3] = 255;
        }
        ctx.putImageData(adjusted, 0, 0);
      }

      $("#temp").on("input", function () {
        $("#tempVal").text($(this).val());
        $("#tempInput").val($(this).val());
        updateAdjust();
      });
      $("#tempInput").on("input", function () {
        $("#tempVal").text($(this).val());
        $("#temp").val($(this).val());
        updateAdjust();
      });
      $("#tint").on("input", function () {
        $("#tintVal").text($(this).val());
        $("#tintInput").val($(this).val());
        updateAdjust();
      });
      $("#tintInput").on("input", function () {
        $("#tintVal").text($(this).val());
        $("#tint").val($(this).val());
        updateAdjust();
      });

      // ä¸‹è½½
      $("#download").on("click", function () {
        let link = document.createElement("a");
        link.download = "corrected_film.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    });
  </script>
</body>
</html>