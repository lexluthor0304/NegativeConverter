<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>LibRaw WASM DNG Test</title>
  <!-- 以模块方式导入 LibRaw -->
  <script type="module">
    import LibRaw from './index.js';
    window.LibRaw = LibRaw;
  </script>
  <style>
    body { background: #222; color: #fff; text-align: center; font-family: sans-serif; }
    canvas { border: 1px solid #fff; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>LibRaw WASM DNG Test</h1>
  <p>选择一个 .dng 文件进行测试：</p>
  <input type="file" id="upload" accept=".dng">
  <br>
  <canvas id="canvas"></canvas>

  <script>
    document.getElementById("upload").addEventListener("change", async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(event) {
        const buffer = event.target.result;
        console.log("DEBUG: File loaded, byteLength:", buffer.byteLength);
        try {
          // 创建 LibRaw 实例
          const raw = new LibRaw();
          console.log("DEBUG: LibRaw instance created:", raw);
          // 打开 RAW 文件，设置基本选项
          await raw.open(new Uint8Array(buffer), {
            noInterpolation: false,  // 启用内部去马赛克
            useAutoWb: true,         // 自动白平衡
            useCameraWb: true,       // 使用相机白平衡
            useCameraMatrix: 3,      // 始终使用相机矩阵
            outputColor: 1,          // 输出 sRGB
            outputBps: 8             // 每通道 8 位
          });
          console.log("DEBUG: raw.open succeeded");
          // 获取元数据（可选）
          const meta = await raw.metadata(true);
          console.log("DEBUG: Metadata:", meta);
          // 获取解码后的图像数据
          const imageDataResult = await raw.imageData();
          console.log("DEBUG: ImageData result:", imageDataResult);
          const width = imageDataResult.width;
          const height = imageDataResult.height;
          // LibRaw 返回的是 3 通道 RGB 数据，转换为 RGBA
          const rgbData = new Uint8ClampedArray(imageDataResult.data);
          const pixelCount = width * height;
          const rgbaData = new Uint8ClampedArray(pixelCount * 4);
          for (let i = 0; i < pixelCount; i++) {
            rgbaData[i * 4]     = rgbData[i * 3];     // R
            rgbaData[i * 4 + 1] = rgbData[i * 3 + 1]; // G
            rgbaData[i * 4 + 2] = rgbData[i * 3 + 2]; // B
            rgbaData[i * 4 + 3] = 255;                // A
          }
          const imageData = new ImageData(rgbaData, width, height);
          const canvas = document.getElementById("canvas");
          canvas.width = width;
          canvas.height = height;
          canvas.getContext("2d").putImageData(imageData, 0, 0);
          console.log("DEBUG: Image displayed on canvas.");
        } catch (err) {
          console.error("DEBUG: Error processing RAW:", err);
        }
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>