name: R2 Sync

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "GitHub release tag to sync (e.g. v0.1.0)"
        required: true
        type: string
      update_latest:
        description: "Update negative-converter/release/latest.json"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  sync:
    name: Sync release assets to R2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail
          mkdir -p artifacts
          gh release download "${TAG}" \
            -p '*.dmg' \
            -p '*.msi' \
            -p '*.exe' \
            -p '*.AppImage' \
            -p '*.deb' \
            -p '*.rpm' \
            -D artifacts

      - name: Ensure AWS CLI
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${AWS_ACCESS_KEY_ID}" ] || [ -z "${AWS_SECRET_ACCESS_KEY}" ]; then
            echo "No R2 S3 credentials configured; skipping AWS CLI install."
            exit 0
          fi
          if command -v aws >/dev/null 2>&1; then
            aws --version
            exit 0
          fi
          sudo apt-get update
          sudo apt-get install -y awscli
          aws --version

      - name: Upload installers to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          AWS_REGION: auto
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          TAG: ${{ inputs.tag }}
          UPDATE_LATEST: ${{ inputs.update_latest }}
        run: |
          set -euo pipefail
          if [ -z "${R2_BUCKET}" ]; then
            echo "Missing secret: R2_BUCKET" >&2
            exit 1
          fi

          has_s3="false"
          if [ -n "${AWS_ACCESS_KEY_ID}" ] && [ -n "${AWS_SECRET_ACCESS_KEY}" ] && [ -n "${R2_ENDPOINT}" ]; then
            has_s3="true"
          fi

          has_cf="false"
          if [ -n "${CLOUDFLARE_API_TOKEN}" ] && [ -n "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            has_cf="true"
          fi

          if [ "${has_s3}" != "true" ] && [ "${has_cf}" != "true" ]; then
            echo "Missing R2 credentials." >&2
            echo "Set either (R2_ACCESS_KEY_ID/R2_SECRET_ACCESS_KEY/R2_ENDPOINT) or (CLOUDFLARE_API_TOKEN/CLOUDFLARE_ACCOUNT_ID)." >&2
            exit 1
          fi

          extra=()
          if [ "${UPDATE_LATEST}" = "true" ]; then
            extra+=(--update-latest)
          fi

          python3 .github/scripts/r2_sync_release.py \
            --source-dir artifacts \
            --bucket "${R2_BUCKET}" \
            --endpoint "${R2_ENDPOINT}" \
            --prefix "negative-converter/release" \
            --tag "${TAG}" \
            "${extra[@]}"
